<div class="chat-widget">
  <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ -->
  <button
    type="button"
    class="chat-widget__toggle"
    (click)="toggleOpen()"
    aria-label="–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –í—ã—à–∫–∏"
  >
    <span class="chat-widget__toggle-icon">üí¨</span>
    <span class="chat-widget__toggle-label">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</span>
  </button>

  @if (isOpen) {
    <section class="chat-popup" aria-label="–ß–∞—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –í–®–≠">
      <!-- –®–∞–ø–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
      <header class="chat-popup__header">
        <div class="chat-popup__title-block">
          <div class="chat-popup__logo-circle">–í–®–≠</div>
          <div>
            <h2 class="chat-popup__title">–ü–æ–º–æ—â–Ω–∏–∫ –ø–æ —É—á–µ–±–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º</h2>
            <p class="chat-popup__subtitle">
              –Ø –±–æ—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è –ø–æ–º–æ—â–∏ –ø–æ —É—á–µ–±–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º –í—ã—à–∫–∏
            </p>
          </div>
        </div>

        <div class="chat-popup__header-actions">
          <button
            type="button"
            class="chat-popup__link"
            (click)="onFeedbackClick()"
          >
            –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
          </button>
          <button
            type="button"
            class="chat-popup__link"
            (click)="openProfileView()"
          >
            –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          </button>
          <button
            type="button"
            class="chat-popup__close"
            (click)="close()"
            aria-label="–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç"
          >
            ‚úï
          </button>
        </div>
      </header>

      <!-- –¢–µ–ª–æ —á–∞—Ç–∞ / –ø—Ä–æ—Ñ–∏–ª—å -->
      <main class="chat-popup__body">
        <!-- –†–µ–∂–∏–º: —á–∞—Ç -->
        @if (viewMode === 'chat') {
          <div class="chat-popup__messages">
            @for (message of messages; track message.id) {
              <article
                class="chat-message"
                [class.chat-message--bot]="message.role === 'bot'"
                [class.chat-message--user]="message.role === 'user'"
              >
                <div class="chat-message__avatar">
                  @if (message.role === 'bot') {
                    <span class="chat-message__avatar-icon">ü§ñ</span>
                  } @else {
                    <span class="chat-message__avatar-icon">üë§</span>
                  }
                </div>

                <div class="chat-message__content">
                  <header class="chat-message__meta">
                    <span class="chat-message__author">
                      @if (message.role === 'bot') { –ë–æ—Ç } @else { –¢—ã }
                    </span>
                    @if (message.timestamp) {
                      <span class="chat-message__time">
                        {{ message.timestamp }}
                      </span>
                    }
                  </header>

                  <p class="chat-message__bubble">
                    {{ message.text }}
                  </p>
                </div>
              </article>
            }

            @if (isWaitingForModel) {
              <div class="chat-popup__status">
                <span class="chat-popup__spinner"></span>
                <span>–ò–ò-–º–æ–¥–µ–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å‚Ä¶</span>
              </div>
            }
          </div>

          <!-- –ü–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø.2) -->
          @if (stage === 'chooseCategory') {
            <section class="chat-popup__panel">
              <p class="chat-popup__panel-title">
                –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–≤–æ–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞:
                <strong>{{ currentCategory }}</strong>. –í—ã–±–µ—Ä–∏ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:
              </p>
              <div class="chat-popup__buttons-row">
                @for (section of availableSections; track section) {
                  <button
                    type="button"
                    class="chip-button"
                    (click)="onSectionSelect(section)"
                  >
                    {{ section }}
                  </button>
                }
              </div>
            </section>
          }

          <!-- –ü–∞–Ω–µ–ª—å "–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω –ª–∏ –æ—Ç–≤–µ—Ç–æ–º?" (–ø.5) -->
          @if (stage === 'rateAnswer') {
            <section class="chat-popup__panel">
              <p class="chat-popup__panel-title">
                –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω(–∞) –ª–∏ —Ç—ã –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º?
              </p>
              <div class="chat-popup__buttons-row">
                <button
                  type="button"
                  class="primary-button"
                  (click)="onRate(true)"
                >
                  –î–∞, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω
                </button>
                <button
                  type="button"
                  class="secondary-button"
                  (click)="onRate(false)"
                >
                  –ù–µ—Ç, –Ω–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω
                </button>
              </div>
            </section>
          }

          <!-- –ü–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ "–ù–µ—Ç" (–ø.7) -->
          @if (stage === 'afterNegative') {
            <section class="chat-popup__panel">
              <p class="chat-popup__panel-title">–ö–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–∏–º?</p>
              <div class="chat-popup__buttons-row">
                <button
                  type="button"
                  class="primary-button"
                  (click)="onClarifyCurrent()"
                >
                  –£—Ç–æ—á–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
                </button>
                <button
                  type="button"
                  class="secondary-button"
                  (click)="onAskNew()"
                >
                  –ó–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å
                </button>
              </div>
            </section>
          }
        }

        <!-- –†–µ–∂–∏–º: –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        @if (viewMode === 'profile') {
          <section class="chat-popup__profile">
            <h3 class="chat-popup__profile-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <p class="chat-popup__profile-desc">
              –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–æ–≥—É—Ç –±–æ—Ç—É –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.
            </p>

            @if (userProfileDraft) {
              <form
                class="profile-form"
                (ngSubmit)="onSaveProfile()"
                autocomplete="off"
              >
                <div class="profile-form__row">
                  <label class="profile-form__label" for="profile-level">
                    –£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
                  </label>
                  <select
                    id="profile-level"
                    class="profile-form__control"
                    name="profileLevel"
                    [(ngModel)]="userProfileDraft.level"
                  >
                    <option value="" disabled>–í—ã–±–µ—Ä–∏ —É—Ä–æ–≤–µ–Ω—å</option>
                    <option value="–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç">–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç</option>
                    <option value="–º–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞">–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞</option>
                    <option value="–∞—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞">–ê—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞</option>
                    <option value="—à–∫–æ–ª–∞/–ª–∏—Ü–µ–π">–®–∫–æ–ª–∞ / –ª–∏—Ü–µ–π</option>
                    <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                  </select>
                </div>

                <div class="profile-form__row">
                  <label class="profile-form__label" for="profile-campus">
                    –ö–∞–º–ø—É—Å
                  </label>
                  <select
                    id="profile-campus"
                    class="profile-form__control"
                    name="profileCampus"
                    [(ngModel)]="userProfileDraft.campus"
                  >
                    <option value="" disabled>–í—ã–±–µ—Ä–∏ –∫–∞–º–ø—É—Å</option>
                    <option value="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞</option>
                    <option value="–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥">–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥</option>
                    <option value="–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥">–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥</option>
                    <option value="–ü–µ—Ä–º—å">–ü–µ—Ä–º—å</option>
                    <option value="–û–Ω–ª–∞–π–Ω">–û–Ω–ª–∞–π–Ω</option>
                    <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                  </select>
                </div>

                <div class="profile-form__actions">
                  <button
                    type="button"
                    class="secondary-button"
                    (click)="onCancelProfileEdit()"
                  >
                    –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–∞—Ç—É
                  </button>
                  <button type="submit" class="primary-button">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                </div>
              </form>
            }
          </section>
        }
      </main>

      <!-- –§—É—Ç–µ—Ä: —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞ -->
      <footer class="chat-popup__footer">
        @if (viewMode === 'chat') {
          <form class="chat-input" (ngSubmit)="onSubmit()" autocomplete="off">
            <textarea
              class="chat-input__field"
              name="question"
              [(ngModel)]="currentInput"
              [placeholder]="inputPlaceholder"
              [disabled]="isInputDisabled"
              rows="1"
            ></textarea>
            <button
              type="submit"
              class="chat-input__send"
              [disabled]="isInputDisabled || !currentInput.trim()"
            >
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </form>

          @if (stage === 'askQuestion') {
            <p class="chat-popup__hint">
              –°–Ω–∞—á–∞–ª–∞ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å ‚Äî –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é
              –∏ –ø–æ–¥–±–µ—Ä—ë—Ç –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª.
            </p>
          }

          @if (stage === 'clarifyQuestion') {
            <p class="chat-popup__hint">
              –ù–∞–ø–∏—à–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –≤ —Ç–µ–∫—É—â–µ–º –æ—Ç–≤–µ—Ç–µ.
            </p>
          }
        }

        @if (viewMode === 'profile') {
          <p class="chat-popup__hint">
            –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–¥–∞–π –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —É—Ç–æ—á–Ω–∏ —Ç–µ–∫—É—â–∏–π ‚Äî
            –±–æ—Ç —É—á—Ç—ë—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
          </p>
        }
      </footer>
    </section>
  }
</div>
